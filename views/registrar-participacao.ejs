<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Registrar / Cancelar ParticipaÃ§Ã£o - Semana AcadÃªmica</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Reset bÃ¡sico */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        #btnToggle.registrar {
            background-color: #4CAF50;
            color: white;
        }

        #btnToggle.registrar:hover {
            background-color: #45a049;
        }

        #btnToggle.cancelar {
            background-color: #f44336;
            color: white;
        }

        #btnToggle.cancelar:hover {
            background-color: #da190b;
        }

        #btnStart {
            background-color: #2196F3;
            color: white;
        }

        #btnStart:hover {
            background-color: #0b7dda;
        }

        #reader {
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            display: none;
        }

        #resultado {
            font-size: 16px;
            margin-top: 10px;
            color: #2e7d32;
            text-align: center;
            word-wrap: break-word;
        }

        #erro {
            font-size: 16px;
            margin-top: 5px;
            color: #d32f2f;
            text-align: center;
            word-wrap: break-word;
        }

        /* Responsividade */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            button {
                font-size: 16px;
                padding: 12px;
            }

            select {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <h1>Registrar / Cancelar ParticipaÃ§Ã£o</h1>

    <div class="container">

        <select id="eventoSelect">
            <option value="">-- Escolha o evento --</option>
            <% eventos.forEach(e=> { %>
                <option value="<%= e.id %>">
                    <%= e.nome %>
                </option>
                <% }) %>
        </select>

        <button id="btnToggle" class="registrar">ðŸ”µ Modo: Registrar ParticipaÃ§Ã£o</button>
        <button id="btnStart">ðŸ“· Iniciar Scanner</button>

        <div id="reader"></div>

        <div id="resultado"></div>
        <div id="erro"></div>
    </div>

    <script>
        const resultado = document.getElementById("resultado");
        const erro = document.getElementById("erro");
        const eventoSelect = document.getElementById("eventoSelect");
        const btnStart = document.getElementById("btnStart");
        const btnToggle = document.getElementById("btnToggle");
        const readerDiv = document.getElementById("reader");

        let html5QrcodeScanner;
        let modo = "registrar"; // "registrar" ou "cancelar"

        // Alterna entre registrar e cancelar
        btnToggle.addEventListener("click", () => {
            if (modo === "registrar") {
                modo = "cancelar";
                btnToggle.textContent = "ðŸ”´ Modo: Cancelar ParticipaÃ§Ã£o";
                btnToggle.className = "cancelar";
            } else {
                modo = "registrar";
                btnToggle.textContent = "ðŸ”µ Modo: Registrar ParticipaÃ§Ã£o";
                btnToggle.className = "registrar";
            }
        });

        function registrarOuCancelar(matricula, eventoId) {
            if (!eventoId) {
                erro.innerText = "Selecione o evento!";
                return;
            }

            const url = `/participacao/${matricula}/${eventoId}`;
            const method = modo === "registrar" ? "POST" : "DELETE";

            fetch(url, { method })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        erro.innerText = data.error;
                        resultado.innerText = "";
                    } else {
                        const acao = modo === "registrar" ? "Registrado" : "Cancelado";
                        resultado.innerText = `${acao}: ${data.aluno.nome} | Pontos: ${data.aluno.pontos}`;
                        erro.innerText = "";
                    }
                })
                .catch(e => {
                    erro.innerText = "Erro na requisiÃ§Ã£o";
                    resultado.innerText = "";
                    console.error(e);
                });
        }

        function onScanSuccess(decodedText, decodedResult) {
            const eventoId = eventoSelect.value;
            try {
                let payload = JSON.parse(decodedText);

                if (payload) {
                    registrarOuCancelar(payload, eventoId);

                    // Fecha scanner e habilita botÃ£o novamente
                    html5QrcodeScanner.stop().then(() => {
                        html5QrcodeScanner.clear();
                        readerDiv.style.display = "none";
                        btnStart.disabled = false;
                    }).catch(err => console.error("Erro ao parar scanner:", err));
                } else {
                    erro.innerText = "QR Code invÃ¡lido!";
                }
            } catch (e) {
                erro.innerText = "Erro ao ler QR Code!";
                console.error(e);
            }
        }

        btnStart.addEventListener("click", () => {
            if (!eventoSelect.value) {
                erro.innerText = "Selecione o evento antes de iniciar!";
                return;
            }

            resultado.innerText = "";
            erro.innerText = "";

            readerDiv.style.display = "block";
            btnStart.disabled = true;

            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                onScanSuccess
            ).catch(err => {
                erro.innerText = "Erro ao iniciar cÃ¢mera!";
                console.error(err);
                btnStart.disabled = false;
            });
        });
    </script>
</body>

</html>